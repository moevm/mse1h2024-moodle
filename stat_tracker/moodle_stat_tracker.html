<script>
    var Interactor = function (config) {
        this.__init__(config);
    };

    Interactor.prototype = {

        __init__: function (config) {

            var interactor = this;

            interactor.interactions = typeof (config.interactions) == "boolean" ? config.interactions : true,
                interactor.trackAll = typeof (config.trackAll) == "boolean" ? config.trackAll : false,
                interactor.numberActionsToSend = typeof (config.numberActionsToSend) == "number" ? config.numberActionsToSend : 15,
                interactor.trackPagePresence = typeof (config.trackPagePresence) == "boolean" ? config.trackPagePresence : true,
                interactor.interactionElement = Array.isArray(config.interactionElement) === true ? config.interactionElement : [],
                interactor.interactionEvents = Array.isArray(config.interactionEvents) === true ? config.interactionEvents : ['mouseup', 'touchend'],
                interactor.conversions = typeof (config.conversions) == "boolean" ? config.conversions : true,
                interactor.conversionElement = typeof (config.conversionElement) == "string" ? config.conversionElement : 'conversion',
                interactor.conversionEvents = Array.isArray(config.conversionEvents) === true ? config.conversionEvents : ['mouseup', 'touchend'],
                interactor.endpoint = typeof (config.endpoint) == "string" ? config.endpoint : '/interactions',
                interactor.async = typeof (config.async) == "boolean" ? config.async : true,
                interactor.debug = typeof (config.debug) == "boolean" ? config.debug : true,
                interactor.records = [],
                interactor.session = {},
                interactor.loadTime = new Date();

            interactor.__initializeSession__();
            interactor.__bindEvents__();


            return interactor;
        },

        __bindEvents__: function () {
            var interactor = this;
            
            if (interactor.trackPagePresence)
                document.addEventListener("visibilitychange", function (e) {
                    e.stopPropagation();
                    if(interactor.debug)
                        console.log(e.target)
                    interactor.__addInteraction__(e, document.visibilityState, 'page');
                    });

            if (interactor.trackAll) {
                for (var i = 0; i < interactor.interactionEvents.length; i++) {
                    document.querySelector('body').addEventListener(interactor.interactionEvents[i], function (e) {
                        e.stopPropagation();
                        if(interactor.debug)
                            console.log(e.target)
                        interactor.__addInteraction__(e, "conversation", 'button');
                    });
                }
                

            }
            else if (interactor.interactions === true) {
                for (var i = 0; i < interactor.interactionEvents.length; i++) {
                    document.querySelector('body').addEventListener(interactor.interactionEvents[i], function (e) {
                        e.stopPropagation();
                        if (interactor.interactionElement.includes(e.target.nodeName)) {
                            if(interactor.debug)
                                console.log(e.target)
                            interactor.__addInteraction__(e, "conversation", 'button');
                        }
                    });
                }
            }

            window.onbeforeunload = function (e) {
                interactor.__sendInteractions__();
            };

            return interactor;
        },

        __addInteraction__: function (e, type, element_type) {

            var interactor = this;

            date = new Date();
            let name;
            if (e.target.nodeName == 'BUTTON')
                name = e.target.innerText
            else
                name = e.target.nodeName.toLowerCase()
            trackingEntity = {
                date: `${date.toISOString()}`,
                page: interactor.session.page.href,
                element_type: element_type,
                element_name: name,
                action_type: type, // TODO согласовать action_type с бд
                event_type: e.type
            }
            interactor.records.push(trackingEntity);

            if (interactor.debug) {
                interactor.__closeSession__();
                console.log("Session:\n", interactor.session);
            }
            if (interactor.numberActionsToSend === interactor.records.length){    
                interactor.__sendInteractions__()
                interactor.records = []
            }
            return interactor;
        },

        __initializeSession__: function () {
            var interactor = this;

            interactor.session = {
                loadTime: interactor.loadTime,
                unloadTime: new Date(),
                language: window.navigator.language,
                platform: window.navigator.platform,
                port: window.location.port,
                clientStart: {
                    name: window.navigator.appVersion,
                    innerWidth: window.innerWidth,
                    innerHeight: window.innerHeight,
                    outerWidth: window.outerWidth,
                    outerHeight: window.outerHeight
                },
                page: {
                    location: window.location.pathname,
                    href: window.location.href,
                    origin: window.location.origin,
                    title: document.title
                },
                endpoint: interactor.endpoint
            };

            return interactor;
        },

        __closeSession__: function () {

            var interactor = this;

            interactor.session.unloadTime = new Date();
            interactor.session.interactions = interactor.records;
            interactor.session.clientEnd = {
                name: window.navigator.appVersion,
                innerWidth: window.innerWidth,
                innerHeight: window.innerHeight,
                outerWidth: window.outerWidth,
                outerHeight: window.outerHeight
            };

            return interactor;
        },


        __sendInteractions__: function () {

            var interactor = this;
            if (interactor.records.length === 0) return interactor;
            var xhr = new XMLHttpRequest();

            interactor.__closeSession__();

            xhr.open('POST', interactor.endpoint, interactor.async);
            xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
            var trackingEntity = {               
                student: "Иванов Иван", // getUserName()
                email: "iiivanov@edu.ru", //getUserEmail(function(email))
                //user_id: getUserID(),
                course: "Курс молодого бойца", // getCourseName()
                session: "123",
                actions: interactor.records
            }
            
            xhr.send(JSON.stringify(trackingEntity));

            return interactor;
        }

    };
</script>



<script type="module">
    function getUserName() { // works only on e.moevm.info
        return document
            .getElementById('action-menu-toggle-1')
            .getElementsByClassName('usertext')[0]
            .innerText;
    }

    function getCourseName() { // works only on e.moevm.info
        return document
        .getElementById('page-header')
        .getElementsByTagName('h1')[0]
        .innerText
    }

    function getUserID(){ // works only on e.moevm.info
        return document
        .getElementById('page-footer')
        .getElementsByTagName('a')[0]
        .getAttribute("href").slice(41)
    }

    function getUserEmail(callback) { // works only on e.moevm.info
        var id = getUserID();
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "https://e.moevm.info/user/profile.php?id=" + id);
        xhr.responseType = 'document';
        xhr.send();
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
            var doc = xhr.response;
            var email = doc.getElementById('region-main')
              .getElementsByTagName('a')[1].innerText;
            callback(email);
    }
  }
}


    var interactions = new Interactor({
        trackAll: false,
        numberActionsToSend: 15,
        trackPagePresence: true,
        interactions: true,
        interactionElement: ["A", "BUTTON", "TEXTAREA", "INPUT"],
        interactionEvents: ["mousedown", "copy", "paste"],
        conversions: true,
        conversionElement: "conversion",
        conversionEvents: ["mouseup", "touchend"],
        endpoint: 'http://localhost:8080/api/statistics',
        async: true,
        debug: true
    });
</script>